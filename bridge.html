<html>
  <head>
    <meta charset="utf-8" />
    <script src="dist/excel-templator.js"></script>
  </head>
  <body>
    <script>
      window.addEventListener("message", (msg) => {
        if (!msg || !msg.data) {
          return;
        }
        try {
          const parsed = JSON.parse(msg.data);
          handleMessage(parsed);
        } catch (e) {
          console.warn(e);
        }
      });

      function postMessage(msg) {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(msg);
        } else {
          window.postMessage(msg);
        }
      }

      function handleMessage(msg) {
        const operation = msg.operation;
        if (operation === "parse") {
          parse(msg);
        } else if (operation === "generate") {
          generate(msg);
        }
      }

      function load(msg) {
        if (window.templator) {
          return window.templator;
        }
        const excelUrl = msg.excelUrl;
        const fetcher = new BrowserFetcher();
        window.templator = new ExcelTemplator(excelUrl, fetcher);
        return window.templator;
      }

      async function parse(msg) {
        const template = load(msg);

        const sheetMap = await template.parse();
        const res = { sheetMap };
        postMessage(JSON.stringify(res));
      }

      async function generate(msg) {
        const template = load(msg);

        const data = msg.data;
        const sheetMap = msg.sheetMap;
        const buffer = await template.generate(data, sheetMap);
        const blob = new Blob([buffer]);
        const reader = new FileReader();
        const dataUrl = await new Promise()((resolve, reject) => {
          reader.onerror = function (ev) {
            reject(reader.error || ev);
          };
          reader.onload = function () {
            resolve(reader.result);
          };
          reader.readAsDataURL(blob);
        });
        const res = { dataUrl };
        postMessage(JSON.stringify(res));
      }
    </script>
  </body>
</html>
